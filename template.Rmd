---
title: "STAT 345 Address Final Project"
output: word_document
date: "2025-11-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Section One

_Maps_ The US Census Bureau provides mapping shape files for a variety of variables across the entire United States. You can explore these at [https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html](https://www.census.gov/geographies/mapping-files/time-series/geo/tiger-line-file.html). Make a map that displays county boundaries for the entire United States. You may use whichever package for plotting that you'd like, though you might find the 'ggmap' and 'rdgal' packages (and related tutorials) informative here.
```{r, Blake}

library(tigris)
library(sf)
library(ggplot2)

# - tigris: Downloads US Census TIGER/Line geographic data (counties, roads, etc.)
# - sf: "Simple Features" package for working with spatial data (points, lines, polygons)

options(tigris_use_cache = TRUE)
# - Tells tigris to CACHE (save locally) downloaded data



# Download U.s.County Boundries
us_counties <- counties(cb = FALSE, class = "sf")

# - counties() is a tigris function that downloads US county shapefile
# - cb = FALSE: downloads DETAILED TIGER geometry (full county boundaries)

# Remove any invalid or empty geometries
us_counties <- st_make_valid(us_counties)
us_counties <- us_counties[!st_is_empty(us_counties), ]

# keep only contiguous US
state_keep <- tigris::states(cb = TRUE) |> 
  st_drop_geometry() |>
  filter(!STUSPS %in% c("AS","GU","MP","PR","VI", "AK", "HI")) |>  # drop territories and states not contiguous
  pull(STATEFP)

us_counties <- us_counties |> 
  filter(STATEFP %in% state_keep)

# - st_make_valid(): Fixes any self-intersecting or invalid polygons 
# - [!st_is_empty(us_counties), ]: Removes rows where geometry is empty

# Print prgress and data
cat("✓ Downloaded ", nrow(us_counties), " county records\n", sep = "")


cat("  Geometry type: ", unique(st_geometry_type(us_counties)), "\n", sep = "")


# - st_geometry_type() tells you what kind of shape each row is (POLYGON, MULTIPOLYGON, etc.)
# - unique() shows only the distinct types (all should be POLYGON or MULTIPOLYGON)

# was used to shift the states that weren't contiguous but we aren't doing that anymore
us_counties_shift <- us_counties


# create directories for outputs
if (!dir.exists("data_raw")) dir.create("data_raw", recursive = TRUE)
if (!dir.exists("data_processed")) dir.create("data_processed", recursive = TRUE)
if (!dir.exists("figures")) dir.create("figures", recursive = TRUE)

# Creates three folders


# Save Raw data
saveRDS(us_counties, "data_raw/counties_us_tiger.rds")

# - Next time this script is ran, tigris will use cached version 
# File format: .rds is R's native binary format
# - Smaller than CSV (compressed)
# - Preserves all R object structure (columns, types, spatial info)


# Create Map 
map_counties <- ggplot(us_counties_shift) +
  geom_sf(fill = NA, color = "gray30", linewidth = 0.1) +
  coord_sf(crs = 5070) +   #crs = 5070 is the standard mapping system and makes it so US is portrayed as ture size
  theme_void() + # removes ticks, gridmarks, nonesetial parts
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray40")
  ) +
  labs(
    title = "United States County Boundaries",
    subtitle = "TIGER/Line 2023 | n = 3,233 counties | EPSG:5070"
  )


# Save Map as png
ggsave(
  "figures/01_us_counties_base_map.png",
  plot = map_counties,
  width = 16,
  height = 10,
  dpi = 300,
  units = "in"
)

print(map_counties)


us_counties_shift_proj <- st_transform(us_counties_shift, crs = 5070)


# - st_transform(): Converts/reprojects spatial data to a new CRS
# - crs = 5070: Project to EPSG:5070 (same as what the map uses)
# - Stores result in new object: us_counties_shift_proj

saveRDS(us_counties_shift_proj, "data_processed/counties_us_shift_5070.rds")

# What it does:
# - Saves the projected counties as .rds file to data_processed
# so that in the next part this code does not have to be reran


# Summary
cat("Summary:\n")
cat("  • Total counties: ", nrow(us_counties), "\n", sep = "")
cat("  • States: ", n_distinct(us_counties$STATEFP), "\n", sep = "")
cat("  • CRS: EPSG:5070 (Albers Equal Area Conic - USGS Standard)\n")
cat("  • Base map saved to: figures/01_us_counties_base_map.png\n\n")
cat("  • data_processed/counties_us_shift_5070.rds\n\n")

```
```{r Isaac}
base_url <- "https://www2.census.gov/geo/tiger/TIGER2023/ROADS"
url <- file.path(base_url, zip_links[[1]])  # now it's a full URL
outdir <- "roads_temp"
dir.create(outdir, showWarnings = FALSE)

geoid <- stringr::str_extract(basename(url), "\\d{5}")
zipfile <- file.path(outdir, basename(url))

download.file(url, zipfile, mode = "wb", quiet = TRUE)
unzip(zipfile, exdir = outdir)

shp <- list.files(outdir, pattern = "\\.shp$", full.names = TRUE)
roads_sf <- sf::st_read(shp[1], quiet = TRUE)
```



## Section Two

2. _Roads_ Your goal in this step is to summarize (tabulate) the road suffixes for each county in the United States. County-level data can be found at [https://www2.census.gov/geo/tiger/TIGER2023/ROADS/](https://www2.census.gov/geo/tiger/TIGER2023/ROADS/). There are over 3000 files here, with file names that include the 5-digit GEOID for the county. As you process this data, you'll need to manage your memory in R. You'll likely want to download the file, unzip it, read it, summarize it, and then remove the file from memory. This is a great place for a function! Be sure to include the GEOID in your summary data for the next step.

```{r James}


```
## Section Three

3. _Putting it Together_ Merge the county shape files with your county-level summaries. The main plot to create for the project is to color your map from step 1 based on the most common road suffix (summary from step 2). Beyond this plot, feel free to be creative when making at least two additional plots.


```{r}
library(leaflet)

# Convert counties to WGS84 (leaflet requires this)
us_counties_wgs84 <- st_transform(us_counties_shift, crs = 4326)

# Create interactive map
map_leaflet <- leaflet(us_counties_wgs84) %>%
  addTiles() %>%  # Add background map tiles (OpenStreetMap)
  addPolygons(
    color = "gray30",
    weight = 0.5,
    fillOpacity = 0.1,
    popup = ~NAME  # Click county to see its name
  )

# Display
map_leaflet




```
## Section Four

```{r student4}
library(sf)
library(dplyr)
library(tidyverse)
library(leaflet)
library(ggplot2)
# Zip file gotten from "https://hazards.fema.gov/nri/data-resources#shpDownload". Use the "All Counties - County-level detail (Shapefile)" data set
unzip("NRI_Shapefile_Counties.zip", exdir = "temp_shp")
  #unzips the zip file containing the shape files and creates a temporary directory to read from
shp <- st_read("temp_shp/NRI_Shapefile_Counties.shp")
  #read the temp_shp file from the un-zipped zip file
```
```{r}

hailData <- shp %>%
  filter(!STATEFIPS %in% c(78, 72, 69, 66, 60, 15, "02"))%>%
    #filters the data by getting rid of any non US territories and Alaska/hawaii
    #02 is in quotations because it is a character but when 02 was entered it read it as a number so it read it a 2 and would not filter it out
  select(HAIL_RISKS,NRI_ID,COUNTYFIPS,COUNTY,STCOFIPS)%>%
    #selects the hail risks data along with other important data
  mutate(HAIL_RISKS = ifelse(HAIL_RISKS < 0, NA, HAIL_RISKS))
    #the data set sets all NA values to -9999.000000 so this changes those to NA values
hailData <- st_transform(hailData, crs = 4326) 
    #Transforms the shape data to a more graph friendly scale
ggplot(hailData) +
    #creates the plot
  geom_sf(aes(fill = HAIL_RISKS), color = "black", size = 0.1) +
    #adds the county lines and sets the fill to the hail risk
  scale_fill_gradient(low = "lightblue", high = "darkred", na.value = "grey80") +
    #changes the fill to a gradient
  theme_void() +
  labs(title = "Hail Risk by County",
       fill = "Hail Risk")
    #Adds titles

tornadoData <- shp %>%
  filter(!STATEFIPS %in% c(78, 72, 69, 66, 60, 15, "02"))%>%
    #filters the data by getting rid of any non US territories and Alaska/hawaii
  select(TRND_RISKS,NRI_ID,COUNTYFIPS,COUNTY,STCOFIPS)%>%
    #selects the tornado risk data along with other important data
  mutate(TRND_RISKS = ifelse(TRND_RISKS < 0, NA, TRND_RISKS))
    #the data set sets all NA values to -9999.000000 so this changes those to NA values
tornadoData <- st_transform(tornadoData, crs = 4326)
    #Transforms the shape data to a more graph friendly scale
ggplot(tornadoData) +
    #creates the plot
  geom_sf(aes(fill = TRND_RISKS), color = "black", size = 0.1) +
    #adds the county lines and sets the fill to the tornado risk
  scale_fill_gradient(low = "lightblue", high = "darkred", na.value = "grey80") +
    #changes the fill to a gradient
  theme_void() +
  labs(title = "Tornado Risk By County",
       fill = "Tornado Risk")
    #Adds titles to plot
```
